name: Security Vulnerability Scan

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]
  schedule:
    - cron: '0 6 * * *'  # Daily at 6 AM UTC
  workflow_dispatch:

permissions:
  contents: read
  security-events: write
  pull-requests: write

jobs:
  # Job 1: Block PRs with vulnerabilities
  dependency-review:
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    steps:
      - uses: actions/checkout@v4
      - uses: actions/dependency-review-action@v4
        with:
          fail-on-severity: high
          comment-summary-in-pr: always

  # Job 2: npm audit scan
  npm-audit:
    runs-on: ubuntu-latest
    if: hashFiles('package.json') != ''
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: npm ci --ignore-scripts 2>/dev/null || npm install --ignore-scripts

      - name: Run npm audit
        id: audit
        continue-on-error: true
        run: |
          npm audit --audit-level=high --json > audit-results.json 2>&1 || true

          HIGH=$(cat audit-results.json | jq '.metadata.vulnerabilities.high // 0' 2>/dev/null || echo "0")
          CRITICAL=$(cat audit-results.json | jq '.metadata.vulnerabilities.critical // 0' 2>/dev/null || echo "0")

          echo "high=$HIGH" >> $GITHUB_OUTPUT
          echo "critical=$CRITICAL" >> $GITHUB_OUTPUT

          if [ "$CRITICAL" -gt 0 ] || [ "$HIGH" -gt 0 ]; then
            echo "vulnerable=true" >> $GITHUB_OUTPUT
          else
            echo "vulnerable=false" >> $GITHUB_OUTPUT
          fi

      - name: Fail on critical vulnerabilities
        if: steps.audit.outputs.critical != '0'
        run: |
          echo "âŒ Found ${{ steps.audit.outputs.critical }} critical vulnerabilities"
          exit 1

  # Job 3: Check for React2Shell and Next.js CVEs
  critical-cve-check:
    runs-on: ubuntu-latest
    if: hashFiles('package.json') != ''
    steps:
      - uses: actions/checkout@v4

      - name: Check for critical CVEs
        id: cve
        run: |
          VULNERABLE=false
          MESSAGES=""

          if [ -f "package.json" ]; then
            # Check React version
            REACT=$(cat package.json | jq -r '.dependencies.react // .devDependencies.react // "none"' | grep -oP '\d+\.\d+\.\d+' || echo "none")
            if [[ "$REACT" =~ ^19\. ]]; then
              MAJOR=19
              MINOR=$(echo $REACT | cut -d. -f2)
              PATCH=$(echo $REACT | cut -d. -f3)
              if [[ "$MINOR" == "0" && "$PATCH" == "0" ]] || \
                 [[ "$MINOR" == "1" && "$PATCH" -lt "2" ]] || \
                 [[ "$MINOR" == "2" && "$PATCH" == "0" ]]; then
                VULNERABLE=true
                MESSAGES="React $REACT â†’ CVE-2025-55182 (React2Shell)"
              fi
            fi

            # Check Next.js version
            NEXT=$(cat package.json | jq -r '.dependencies.next // .devDependencies.next // "none"' | grep -oP '\d+\.\d+\.\d+' || echo "none")
            if [[ "$NEXT" =~ ^15\. ]] || [[ "$NEXT" =~ ^16\. ]]; then
              MAJOR=$(echo $NEXT | cut -d. -f1)
              MINOR=$(echo $NEXT | cut -d. -f2)
              PATCH=$(echo $NEXT | cut -d. -f3)

              VULN=false
              if [[ "$MAJOR" == "15" ]]; then
                case "$MINOR" in
                  0) [[ "$PATCH" -lt "5" ]] && VULN=true ;;
                  1) [[ "$PATCH" -lt "9" ]] && VULN=true ;;
                  2) [[ "$PATCH" -lt "6" ]] && VULN=true ;;
                  3) [[ "$PATCH" -lt "6" ]] && VULN=true ;;
                  4) [[ "$PATCH" -lt "8" ]] && VULN=true ;;
                  5) [[ "$PATCH" -lt "7" ]] && VULN=true ;;
                esac
              elif [[ "$MAJOR" == "16" && "$MINOR" == "0" && "$PATCH" -lt "7" ]]; then
                VULN=true
              fi

              if [ "$VULN" == "true" ]; then
                VULNERABLE=true
                MESSAGES="${MESSAGES}\nNext.js $NEXT â†’ CVE-2025-66478"
              fi
            fi
          fi

          echo "vulnerable=$VULNERABLE" >> $GITHUB_OUTPUT
          echo "messages=$MESSAGES" >> $GITHUB_OUTPUT

      - name: Fail on critical CVE
        if: steps.cve.outputs.vulnerable == 'true'
        run: |
          echo "ðŸ”´ Critical CVE detected!"
          echo "${{ steps.cve.outputs.messages }}"
          exit 1

  # Job 4: Trivy deep scan
  trivy-scan:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@0.28.0
        with:
          scan-type: 'fs'
          scan-ref: '.'
          severity: 'HIGH,CRITICAL'
          format: 'sarif'
          output: 'trivy-results.sarif'

      - name: Upload Trivy results to GitHub Security
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: 'trivy-results.sarif'

  # Job 5: Daily scan summary
  daily-summary:
    runs-on: ubuntu-latest
    needs: [npm-audit, critical-cve-check, trivy-scan]
    if: github.event_name == 'schedule' && success()
    steps:
      - name: Create summary
        run: |
          echo "âœ… Daily security scan completed successfully" >> $GITHUB_STEP_SUMMARY
          echo "No critical vulnerabilities found." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Repository:** ${{ github.repository }}" >> $GITHUB_STEP_SUMMARY
          echo "**Time:** $(date -u '+%Y-%m-%d %H:%M UTC')" >> $GITHUB_STEP_SUMMARY
