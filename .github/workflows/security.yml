name: Security Vulnerability Scan

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]
  schedule:
    - cron: '0 6 * * *'  # Daily at 6 AM UTC
  workflow_dispatch:

permissions:
  contents: read
  security-events: write
  pull-requests: write

jobs:
  # Check if package.json exists first
  check-setup:
    runs-on: ubuntu-latest
    outputs:
      has-package-json: ${{ steps.check.outputs.has-package-json }}
    steps:
      - uses: actions/checkout@v4
      - name: Check for package.json
        id: check
        run: |
          if [ -f "package.json" ]; then
            echo "has-package-json=true" >> $GITHUB_OUTPUT
          else
            echo "has-package-json=false" >> $GITHUB_OUTPUT
          fi

  # npm audit scan
  npm-audit:
    runs-on: ubuntu-latest
    needs: check-setup
    if: needs.check-setup.outputs.has-package-json == 'true'
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: npm ci --ignore-scripts 2>/dev/null || npm install --ignore-scripts

      - name: Run npm audit
        id: audit
        continue-on-error: true
        run: |
          npm audit --audit-level=high --json > audit-results.json 2>&1 || true

          HIGH=$(cat audit-results.json | jq '.metadata.vulnerabilities.high // 0' 2>/dev/null || echo "0")
          CRITICAL=$(cat audit-results.json | jq '.metadata.vulnerabilities.critical // 0' 2>/dev/null || echo "0")

          echo "high=$HIGH" >> $GITHUB_OUTPUT
          echo "critical=$CRITICAL" >> $GITHUB_OUTPUT

          if [ "$CRITICAL" -gt 0 ] || [ "$HIGH" -gt 0 ]; then
            echo "vulnerable=true" >> $GITHUB_OUTPUT
          else
            echo "vulnerable=false" >> $GITHUB_OUTPUT
          fi

      - name: Send Telegram Alert (optional)
        if: steps.audit.outputs.vulnerable == 'true' && vars.TELEGRAM_BOT_TOKEN != ''
        env:
          TELEGRAM_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          MESSAGE="üö® *SECURITY ALERT*

          üì¶ Repository: \`${{ github.repository }}\`
          üåø Branch: \`${{ github.ref_name }}\`

          *Vulnerabilities Found:*
          üî¥ Critical: ${{ steps.audit.outputs.critical }}
          üü† High: ${{ steps.audit.outputs.high }}

          [View Details](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})"

          curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_TOKEN}/sendMessage" \
            -d chat_id="${TELEGRAM_CHAT_ID}" \
            -d parse_mode="Markdown" \
            -d text="${MESSAGE}" || echo "Telegram notification failed (token not configured)"

      - name: Fail on critical vulnerabilities
        if: steps.audit.outputs.critical != '0'
        run: |
          echo "‚ùå Found ${{ steps.audit.outputs.critical }} critical vulnerabilities"
          exit 1

  # Check for critical CVEs (React2Shell, Next.js)
  critical-cve-check:
    runs-on: ubuntu-latest
    needs: check-setup
    if: needs.check-setup.outputs.has-package-json == 'true'
    steps:
      - uses: actions/checkout@v4

      - name: Check for critical CVEs
        id: cve
        run: |
          VULNERABLE=false
          MESSAGES=""

          if [ -f "package.json" ]; then
            # Check React version
            REACT=$(cat package.json | jq -r '.dependencies.react // .devDependencies.react // "none"' | grep -oP '\d+\.\d+\.\d+' || echo "none")
            if [[ "$REACT" =~ ^19\. ]]; then
              MAJOR=19
              MINOR=$(echo $REACT | cut -d. -f2)
              PATCH=$(echo $REACT | cut -d. -f3)
              if [[ "$MINOR" == "0" && "$PATCH" == "0" ]] || \
                 [[ "$MINOR" == "1" && "$PATCH" -lt "2" ]] || \
                 [[ "$MINOR" == "2" && "$PATCH" == "0" ]]; then
                VULNERABLE=true
                MESSAGES="React $REACT ‚Üí CVE-2025-55182 (React2Shell)"
              fi
            fi

            # Check Next.js version
            NEXT=$(cat package.json | jq -r '.dependencies.next // .devDependencies.next // "none"' | grep -oP '\d+\.\d+\.\d+' || echo "none")
            if [[ "$NEXT" =~ ^15\. ]] || [[ "$NEXT" =~ ^16\. ]]; then
              MAJOR=$(echo $NEXT | cut -d. -f1)
              MINOR=$(echo $NEXT | cut -d. -f2)
              PATCH=$(echo $NEXT | cut -d. -f3)

              VULN=false
              if [[ "$MAJOR" == "15" ]]; then
                case "$MINOR" in
                  0) [[ "$PATCH" -lt "5" ]] && VULN=true ;;
                  1) [[ "$PATCH" -lt "9" ]] && VULN=true ;;
                  2) [[ "$PATCH" -lt "6" ]] && VULN=true ;;
                  3) [[ "$PATCH" -lt "6" ]] && VULN=true ;;
                  4) [[ "$PATCH" -lt "8" ]] && VULN=true ;;
                  5) [[ "$PATCH" -lt "7" ]] && VULN=true ;;
                esac
              elif [[ "$MAJOR" == "16" && "$MINOR" == "0" && "$PATCH" -lt "7" ]]; then
                VULN=true
              fi

              if [ "$VULN" == "true" ]; then
                VULNERABLE=true
                MESSAGES="${MESSAGES}\nNext.js $NEXT ‚Üí CVE-2025-66478"
              fi
            fi
          fi

          echo "vulnerable=$VULNERABLE" >> $GITHUB_OUTPUT
          echo "messages=$MESSAGES" >> $GITHUB_OUTPUT

      - name: Send Critical CVE Alert (optional)
        if: steps.cve.outputs.vulnerable == 'true' && vars.TELEGRAM_BOT_TOKEN != ''
        env:
          TELEGRAM_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          MESSAGE="üî¥üî¥üî¥ *CRITICAL CVE DETECTED* üî¥üî¥üî¥

          üì¶ Repository: \`${{ github.repository }}\`

          ${{ steps.cve.outputs.messages }}

          ‚ö†Ô∏è *IMMEDIATE ACTION REQUIRED*
          ‚Ä¢ Update dependencies NOW
          ‚Ä¢ Rotate environment secrets

          [View Details](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})"

          curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_TOKEN}/sendMessage" \
            -d chat_id="${TELEGRAM_CHAT_ID}" \
            -d parse_mode="Markdown" \
            -d text="${MESSAGE}" || echo "Telegram notification failed"

      - name: Fail on critical CVE
        if: steps.cve.outputs.vulnerable == 'true'
        run: |
          echo "üî¥ Critical CVE detected!"
          echo "${{ steps.cve.outputs.messages }}"
          exit 1

  # Trivy filesystem scan
  trivy-scan:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@0.28.0
        with:
          scan-type: 'fs'
          scan-ref: '.'
          severity: 'HIGH,CRITICAL'
          format: 'table'

  # Daily summary (only runs on scheduled scans)
  daily-summary:
    runs-on: ubuntu-latest
    needs: [npm-audit, critical-cve-check, trivy-scan]
    if: github.event_name == 'schedule' && success()
    steps:
      - name: Send daily OK notification (optional)
        if: vars.TELEGRAM_BOT_TOKEN != ''
        env:
          TELEGRAM_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          MESSAGE="‚úÖ *Daily Security Scan Complete*

          üì¶ Repository: \`${{ github.repository }}\`
          üïê Time: $(date -u '+%Y-%m-%d %H:%M UTC')

          No critical vulnerabilities found."

          curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_TOKEN}/sendMessage" \
            -d chat_id="${TELEGRAM_CHAT_ID}" \
            -d parse_mode="Markdown" \
            -d text="${MESSAGE}" || echo "Telegram notification skipped"
