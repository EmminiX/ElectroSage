name: Secret Scan Before Public

on:
  workflow_dispatch:  # Manual trigger before making repo public
  push:
    branches: [main]

permissions:
  contents: read
  security-events: write

jobs:
  # Job 1: Gitleaks - scans for secrets in code
  gitleaks:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for thorough scan

      - name: Run Gitleaks
        id: gitleaks
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        continue-on-error: true

      - name: Check for leaks
        id: check
        run: |
          if [ "${{ steps.gitleaks.outcome }}" == "failure" ]; then
            echo "found=true" >> $GITHUB_OUTPUT
          else
            echo "found=false" >> $GITHUB_OUTPUT
          fi

      - name: Alert on secrets found
        if: steps.check.outputs.found == 'true'
        env:
          TELEGRAM_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          MESSAGE="ðŸ”ðŸ”ðŸ” *SECRETS DETECTED IN CODE* ðŸ”ðŸ”ðŸ”

          ðŸ“¦ Repository: \`${{ github.repository }}\`

          âš ï¸ *DO NOT MAKE THIS REPO PUBLIC*

          Potential secrets/credentials found in the codebase.
          Review and remove before publishing.

          [View Scan Results](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})"

          curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_TOKEN}/sendMessage" \
            -d chat_id="${TELEGRAM_CHAT_ID}" \
            -d parse_mode="Markdown" \
            -d text="${MESSAGE}"

      - name: Fail if secrets found
        if: steps.check.outputs.found == 'true'
        run: |
          echo "âŒ SECRETS FOUND - Do not make this repository public!"
          echo "Review the Gitleaks output above for details."
          exit 1

  # Job 2: TruffleHog - deep secret scanning
  trufflehog:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: TruffleHog Scan
        id: trufflehog
        uses: trufflesecurity/trufflehog@main
        with:
          extra_args: --only-verified
        continue-on-error: true

  # Job 3: Check for common secret patterns
  pattern-check:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Check for hardcoded secrets
        id: patterns
        run: |
          FOUND=false
          FINDINGS=""

          # Check for common secret patterns (excluding workflow files that use secrets properly)
          echo "Scanning for potential secrets..."

          # API keys and tokens
          if grep -rn --include="*.js" --include="*.ts" --include="*.py" --include="*.env*" --include="*.json" \
            -E "(api[_-]?key|apikey|secret[_-]?key|auth[_-]?token|access[_-]?token|bearer)" . 2>/dev/null | \
            grep -v "node_modules" | grep -v ".git" | grep -v "process.env" | grep -v "secrets\." | head -20; then
            FOUND=true
            FINDINGS="${FINDINGS}\n- Potential API keys/tokens found"
          fi

          # AWS credentials
          if grep -rn "AKIA[0-9A-Z]{16}" . 2>/dev/null | grep -v ".git" | head -5; then
            FOUND=true
            FINDINGS="${FINDINGS}\n- AWS Access Key ID pattern found"
          fi

          # Private keys
          if grep -rln "BEGIN.*PRIVATE KEY" . 2>/dev/null | grep -v ".git" | head -5; then
            FOUND=true
            FINDINGS="${FINDINGS}\n- Private key files found"
          fi

          # .env files with values
          if find . -name ".env" -o -name ".env.local" -o -name ".env.production" 2>/dev/null | \
            xargs grep -l "=" 2>/dev/null | grep -v ".git" | head -5; then
            FOUND=true
            FINDINGS="${FINDINGS}\n- .env files with values found (should be in .gitignore)"
          fi

          # Database URLs with passwords
          if grep -rn "postgresql://.*:.*@\|mysql://.*:.*@\|mongodb://.*:.*@" . 2>/dev/null | \
            grep -v ".git" | grep -v "node_modules" | grep -v "example" | head -5; then
            FOUND=true
            FINDINGS="${FINDINGS}\n- Database connection strings with credentials found"
          fi

          echo "found=$FOUND" >> $GITHUB_OUTPUT
          echo "findings=$FINDINGS" >> $GITHUB_OUTPUT

          if [ "$FOUND" == "true" ]; then
            echo ""
            echo "âš ï¸ Potential secrets detected!"
            echo "$FINDINGS"
          else
            echo "âœ… No obvious secret patterns found"
          fi

      - name: Alert on patterns found
        if: steps.patterns.outputs.found == 'true'
        env:
          TELEGRAM_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          MESSAGE="âš ï¸ *Potential Secrets Pattern Detected*

          ðŸ“¦ Repository: \`${{ github.repository }}\`

          Found patterns that may indicate hardcoded secrets:
          ${{ steps.patterns.outputs.findings }}

          Please review before making public.

          [View Details](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})"

          curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_TOKEN}/sendMessage" \
            -d chat_id="${TELEGRAM_CHAT_ID}" \
            -d parse_mode="Markdown" \
            -d text="${MESSAGE}"

  # Job 4: Summary
  summary:
    runs-on: ubuntu-latest
    needs: [gitleaks, trufflehog, pattern-check]
    if: always()
    steps:
      - name: Generate summary
        run: |
          echo "## Secret Scan Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Scanner | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|---------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Gitleaks | ${{ needs.gitleaks.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| TruffleHog | ${{ needs.trufflehog.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Pattern Check | ${{ needs.pattern-check.result }} |" >> $GITHUB_STEP_SUMMARY

      - name: All clear notification
        if: needs.gitleaks.result == 'success' && needs.pattern-check.result == 'success'
        env:
          TELEGRAM_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          MESSAGE="âœ… *Secret Scan Complete - All Clear*

          ðŸ“¦ Repository: \`${{ github.repository }}\`

          No secrets or credentials detected.
          Safe to make public."

          curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_TOKEN}/sendMessage" \
            -d chat_id="${TELEGRAM_CHAT_ID}" \
            -d parse_mode="Markdown" \
            -d text="${MESSAGE}"
